<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GamePanelPresenter.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MicroCol game classes</a> &gt; <a href="index.source.html" class="el_package">org.microcol.gui.panelview</a> &gt; <span class="el_source">GamePanelPresenter.java</span></div><h1>GamePanelPresenter.java</h1><pre class="source lang-java linenums">package org.microcol.gui.panelview;

import java.awt.Rectangle;
import java.awt.event.MouseAdapter;
import java.awt.event.MouseEvent;
import java.util.ArrayList;
import java.util.List;

import javax.swing.JMenuItem;
import javax.swing.JPopupMenu;
import javax.swing.JViewport;

import org.microcol.gui.GamePreferences;
import org.microcol.gui.LocalizationHelper;
import org.microcol.gui.Localized;
import org.microcol.gui.PathPlanning;
import org.microcol.gui.Point;
import org.microcol.gui.event.AboutGameEventController;
import org.microcol.gui.event.CenterViewController;
import org.microcol.gui.event.DebugRequestController;
import org.microcol.gui.event.ExitGameController;
import org.microcol.gui.event.FocusedTileController;
import org.microcol.gui.event.FocusedTileEvent;
import org.microcol.gui.event.GameController;
import org.microcol.gui.event.KeyController;
import org.microcol.gui.event.MoveUnitController;
import org.microcol.gui.event.NewGameController;
import org.microcol.gui.event.ShowGridController;
import org.microcol.gui.event.StatusBarMessageController;
import org.microcol.gui.event.StatusBarMessageEvent;
import org.microcol.model.Location;
import org.microcol.model.Ship;
import org.microcol.model.Terrain;
import org.microcol.model.event.ShipMovedEvent;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.common.base.Preconditions;
import com.google.inject.Inject;

public class GamePanelPresenter implements Localized {

<span class="nc" id="L43">	private final Logger logger = LoggerFactory.getLogger(GamePanelPresenter.class);</span>

	public interface Display {

		GamePanelView getGamePanelView();

		Location getCursorLocation();

		void setCursorLocation(Location cursorLocation);

		void setCursorNormal();

		void setCursorGoto();

		boolean isGotoMode();

		void setGotoCursorTitle(Location gotoCursorTitle);

		Location getGotoCursorTitle();

		void setWalkAnimator(WalkAnimator walkAnimator);

		WalkAnimator getWalkAnimator();

		void initGame(boolean idGridShown);

		void setGridShown(boolean isGridShown);

		Area getArea();

		void planScrollingAnimationToPoint(Point targetPoint);

		void stopTimer();

		VisualDebugInfo getVisualDebugInfo();
	}

	private final GameController gameController;

	private final FocusedTileController focusedTileController;

	private final PathPlanning pathPlanning;

	private final GamePanelPresenter.Display display;

	private final StatusBarMessageController statusBarMessageController;

	private Point lastMousePosition;

	private final LocalizationHelper localizationHelper;

	static class PopUpDemo extends JPopupMenu {

		/**
		 * Default serialVersionUID.
		 */
		private static final long serialVersionUID = 1L;

<span class="nc" id="L101">		public PopUpDemo() {</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">			for (int i = 0; i &lt; 10; i++) {</span>
<span class="nc" id="L103">				JMenuItem anItem = new JMenuItem(&quot;Item &quot; + i + &quot; click me!&quot;);</span>
<span class="nc" id="L104">				add(anItem);</span>
			}
<span class="nc" id="L106">		}</span>
	}

	@Inject
	public GamePanelPresenter(final GamePanelPresenter.Display display, final GameController gameController,
			final KeyController keyController, final StatusBarMessageController statusBarMessageController,
			final FocusedTileController focusedTileController, final PathPlanning pathPlanning,
			final MoveUnitController moveUnitController, final NewGameController newGameController,
			final GamePreferences gamePreferences, final ShowGridController showGridController,
			final CenterViewController viewController, final AboutGameEventController gameEventController,
			final ExitGameController exitGameController, final LocalizationHelper localizationHelper,
<span class="nc" id="L117">			final DebugRequestController debugRequestController) {</span>
<span class="nc" id="L118">		this.focusedTileController = focusedTileController;</span>
<span class="nc" id="L119">		this.gameController = Preconditions.checkNotNull(gameController);</span>
<span class="nc" id="L120">		this.statusBarMessageController = Preconditions.checkNotNull(statusBarMessageController);</span>
<span class="nc" id="L121">		this.pathPlanning = Preconditions.checkNotNull(pathPlanning);</span>
<span class="nc" id="L122">		this.display = Preconditions.checkNotNull(display);</span>
<span class="nc" id="L123">		this.localizationHelper = Preconditions.checkNotNull(localizationHelper);</span>

<span class="nc" id="L125">		moveUnitController.addMoveUnitListener(event -&gt; {</span>
<span class="nc" id="L126">			scheduleWalkAnimation(event);</span>
			/**
			 * Wait until animation is finished.
			 */
<span class="nc bnc" id="L130" title="All 4 branches missed.">			while (display.getWalkAnimator() != null &amp;&amp; display.getWalkAnimator().isNextAnimationLocationAvailable()) {</span>
				try {
<span class="nc" id="L132">					Thread.sleep(100);</span>
<span class="nc" id="L133">				} catch (InterruptedException e1) {</span>
					/**
					 * Exception is intentionally sink.
					 */
<span class="nc" id="L137">				}</span>
			}
<span class="nc" id="L139">		});</span>
<span class="nc" id="L140">		moveUnitController.addStartMovingListener(event -&gt; swithToMoveMode());</span>

<span class="nc" id="L142">		keyController.addListener(e -&gt; {</span>
			/**
			 * Escape
			 */
<span class="nc bnc" id="L146" title="All 2 branches missed.">			if (27 == e.getKeyCode()) {</span>
<span class="nc" id="L147">				onKeyPressed_escape();</span>
			}
			/**
			 * Enter
			 */
<span class="nc bnc" id="L152" title="All 2 branches missed.">			if (10 == e.getKeyCode()) {</span>
<span class="nc" id="L153">				onKeyPressed_enter();</span>
			}
<span class="nc" id="L155">			logger.debug(&quot;Pressed key: '&quot; + e.getKeyChar() + &quot;' has code '&quot; + e.getKeyCode() + &quot;', modifiers '&quot;</span>
<span class="nc" id="L156">					+ e.getModifiers() + &quot;'&quot;);</span>
<span class="nc" id="L157">		});</span>

<span class="nc" id="L159">		final MouseAdapter ma = new MouseAdapter() {</span>

			@Override
			public void mousePressed(final MouseEvent e) {
<span class="nc" id="L163">				logger.debug(&quot;mouse pressed at &quot; + e.getX() + &quot;, &quot; + e.getY() + &quot;, &quot; + e.getButton());</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">				if (isMouseEnabled()) {</span>
<span class="nc bnc" id="L165" title="All 2 branches missed.">					if (e.isPopupTrigger()) {</span>
<span class="nc" id="L166">						doPop(e);</span>
					}
<span class="nc" id="L168">					onMousePressed(e);</span>
				}
<span class="nc" id="L170">			}</span>

			@Override
			public void mouseReleased(final MouseEvent e) {
<span class="nc bnc" id="L174" title="All 2 branches missed.">				if (isMouseEnabled()) {</span>
<span class="nc bnc" id="L175" title="All 2 branches missed.">					if (e.isPopupTrigger()) {</span>
<span class="nc" id="L176">						doPop(e);</span>
					}
				}
<span class="nc" id="L179">			}</span>

			@Override
			public void mouseMoved(final MouseEvent e) {
<span class="nc bnc" id="L183" title="All 2 branches missed.">				if (isMouseEnabled()) {</span>
<span class="nc" id="L184">					onMouseMoved(e);</span>
				}
<span class="nc" id="L186">			}</span>

			@Override
			public void mouseDragged(final MouseEvent e) {
<span class="nc bnc" id="L190" title="All 2 branches missed.">				if (isMouseEnabled()) {</span>
<span class="nc" id="L191">					logger.debug(&quot;mouse dragged at &quot; + e.getX() + &quot;, &quot; + e.getY() + &quot;, &quot; + e.getButton());</span>
<span class="nc" id="L192">					onMouseDragged(e);</span>
				}
<span class="nc" id="L194">			}</span>

			private void doPop(MouseEvent e) {
<span class="nc" id="L197">				PopUpDemo menu = new PopUpDemo();</span>
<span class="nc" id="L198">				menu.show(e.getComponent(), e.getX(), e.getY());</span>
<span class="nc" id="L199">			}</span>
		};

<span class="nc" id="L202">		newGameController.addListener(event -&gt; display.initGame(gamePreferences.isGridShown()));</span>

<span class="nc" id="L204">		showGridController.addListener(e -&gt; display.setGridShown(e.isGridShown()));</span>
<span class="nc" id="L205">		debugRequestController.addListener(e -&gt; {</span>
<span class="nc" id="L206">			display.getVisualDebugInfo().setLocations(e.getLocations());</span>
<span class="nc" id="L207">		});</span>

<span class="nc" id="L209">		display.getGamePanelView().addMouseListener(ma);</span>
<span class="nc" id="L210">		display.getGamePanelView().addMouseMotionListener(ma);</span>
<span class="nc" id="L211">		display.getGamePanelView().getParent().addComponentListener(new GamePanelListener(display));</span>
<span class="nc" id="L212">		viewController.addListener(event -&gt; onCenterView());</span>

<span class="nc" id="L214">		exitGameController.addListener(event -&gt; display.stopTimer());</span>

<span class="nc" id="L216">	}</span>

	private boolean isMouseEnabled() {
<span class="nc" id="L219">		return gameController.getModel().getCurrentPlayer().isHuman();</span>
	}

	private void onCenterView() {
<span class="nc" id="L223">		logger.debug(&quot;Center view event&quot;);</span>
<span class="nc" id="L224">		Preconditions.checkNotNull(display.getCursorLocation(), &quot;Cursor location is empty&quot;);</span>
		/**
		 * Here could be verification of race conditions like centering to
		 * bottom right corner of map. Luckily it's done by JViewport.
		 */
<span class="nc" id="L229">		final Point p = display.getArea().getCenterAreaTo(Point.of(display.getCursorLocation()));</span>
<span class="nc" id="L230">		display.planScrollingAnimationToPoint(p);</span>
<span class="nc" id="L231">	}</span>

	private void swithToMoveMode() {
<span class="nc" id="L234">		Preconditions.checkNotNull(display.getCursorLocation(), &quot;Cursor location is empty&quot;);</span>
<span class="nc" id="L235">		final List&lt;Ship&gt; units = gameController.getModel().getCurrentPlayer().getShipsAt(display.getCursorLocation());</span>
		// TODO JJ Filter unit that have enough action points
<span class="nc bnc" id="L237" title="All 2 branches missed.">		Preconditions.checkState(!units.isEmpty(), &quot;there are some moveable units&quot;);</span>
<span class="nc" id="L238">		final Ship unit = units.get(0);</span>
<span class="nc" id="L239">		display.setGotoCursorTitle(lastMousePosition.toLocation());</span>
<span class="nc" id="L240">		logger.debug(&quot;Switching '&quot; + unit + &quot;' to go mode.&quot;);</span>
<span class="nc" id="L241">		display.setCursorGoto();</span>
<span class="nc" id="L242">	}</span>

	private void onKeyPressed_escape() {
<span class="nc bnc" id="L245" title="All 2 branches missed.">		if (display.isGotoMode()) {</span>
<span class="nc" id="L246">			cancelGoToMode(display.getGotoCursorTitle());</span>
		}
<span class="nc" id="L248">	}</span>

	private void onKeyPressed_enter() {
<span class="nc bnc" id="L251" title="All 2 branches missed.">		if (display.isGotoMode()) {</span>
<span class="nc" id="L252">			switchToNormalMode(display.getGotoCursorTitle());</span>
		}
<span class="nc" id="L254">	}</span>

	private void onMousePressed(final MouseEvent e) {
<span class="nc" id="L257">		final Location location = display.getArea().convertToLocation(Point.of(e.getX(), e.getY()));</span>
<span class="nc" id="L258">		logger.debug(&quot;location of mouse: &quot; + location);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">		if (display.isGotoMode()) {</span>
<span class="nc" id="L260">			switchToNormalMode(location);</span>
		} else {
<span class="nc" id="L262">			display.setCursorLocation(location);</span>
<span class="nc" id="L263">			focusedTileController.fireEvent(new FocusedTileEvent(gameController.getModel(), location,</span>
<span class="nc" id="L264">					gameController.getModel().getMap().getTerrainAt(location)));</span>
		}
<span class="nc" id="L266">	}</span>

	private void onMouseDragged(final MouseEvent e) {
<span class="nc bnc" id="L269" title="All 2 branches missed.">		if (lastMousePosition != null) {</span>
<span class="nc" id="L270">			final JViewport viewPort = (JViewport) display.getGamePanelView().getParent();</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">			if (viewPort != null) {</span>
<span class="nc" id="L272">				final Point currentPosition = Point.of(e.getX(), e.getY());</span>
<span class="nc" id="L273">				final Point delta = lastMousePosition.substract(currentPosition);</span>
<span class="nc" id="L274">				final Rectangle view = viewPort.getViewRect();</span>
<span class="nc" id="L275">				view.x += delta.getX();</span>
<span class="nc" id="L276">				view.y += delta.getY();</span>
<span class="nc" id="L277">				display.getGamePanelView().scrollRectToVisible(view);</span>
			}
		}
<span class="nc" id="L280">	}</span>

	private void onMouseMoved(final MouseEvent e) {
<span class="nc" id="L283">		lastMousePosition = Point.of(e.getX(), e.getY());</span>
<span class="nc bnc" id="L284" title="All 2 branches missed.">		if (display.isGotoMode()) {</span>
<span class="nc" id="L285">			display.setGotoCursorTitle(lastMousePosition.toLocation());</span>
		}
		/**
		 * Set status bar message
		 */
<span class="nc" id="L290">		final Location where = lastMousePosition.toLocation();</span>
<span class="nc" id="L291">		final Terrain tile = gameController.getModel().getMap().getTerrainAt(where);</span>
<span class="nc" id="L292">		final StringBuilder buff = new StringBuilder();</span>
<span class="nc" id="L293">		buff.append(getText().get(&quot;statusBar.tile.start&quot;));</span>
<span class="nc" id="L294">		buff.append(&quot; &quot;);</span>
<span class="nc" id="L295">		buff.append(localizationHelper.getTerrainName(tile));</span>
<span class="nc" id="L296">		buff.append(&quot; &quot;);</span>
<span class="nc" id="L297">		buff.append(getText().get(&quot;statusBar.tile.withUnit&quot;));</span>
<span class="nc" id="L298">		buff.append(&quot; &quot;);</span>
<span class="nc" id="L299">		gameController.getModel().getShipsAt(where).forEach(ship -&gt; {</span>
<span class="nc" id="L300">			buff.append(ship.getClass().getSimpleName());</span>
<span class="nc" id="L301">			buff.append(&quot; &quot;);</span>
<span class="nc" id="L302">		});</span>
<span class="nc" id="L303">		statusBarMessageController.fireEvent(new StatusBarMessageEvent(buff.toString()));</span>
<span class="nc" id="L304">	}</span>

	private void cancelGoToMode(final Location moveTo) {
<span class="nc" id="L307">		display.setCursorNormal();</span>
<span class="nc" id="L308">		display.setCursorLocation(moveTo);</span>
<span class="nc" id="L309">		focusedTileController.fireEvent(new FocusedTileEvent(gameController.getModel(), moveTo,</span>
<span class="nc" id="L310">				gameController.getModel().getMap().getTerrainAt(moveTo)));</span>
<span class="nc" id="L311">	}</span>

	private final void switchToNormalMode(final Location moveTo) {
<span class="nc" id="L314">		logger.debug(&quot;Switching to normal mode, from &quot; + display.getCursorLocation() + &quot; to &quot; + moveTo);</span>
<span class="nc" id="L315">		final List&lt;Location&gt; path = new ArrayList&lt;Location&gt;();</span>
<span class="nc" id="L316">		pathPlanning.paintPath(display.getCursorLocation(), moveTo, location -&gt; path.add(location));</span>
<span class="nc bnc" id="L317" title="All 2 branches missed.">		if (path.size() &gt; 0) {</span>
			// TODO JJ active ship can be different from ship first at list
<span class="nc" id="L319">			Ship ship = gameController.getModel().getCurrentPlayer().getShipsAt(display.getCursorLocation()).get(0);</span>
<span class="nc" id="L320">			gameController.performMove(ship, path);</span>
<span class="nc" id="L321">			focusedTileController.fireEvent(new FocusedTileEvent(gameController.getModel(), display.getCursorLocation(),</span>
<span class="nc" id="L322">					gameController.getModel().getMap().getTerrainAt(display.getCursorLocation())));</span>
		}
<span class="nc" id="L324">		display.setCursorLocation(moveTo);</span>
<span class="nc" id="L325">		display.setCursorNormal();</span>
<span class="nc" id="L326">	}</span>

	private void scheduleWalkAnimation(final ShipMovedEvent event) {
<span class="nc bnc" id="L329" title="All 2 branches missed.">		Preconditions.checkArgument(event.getPath().getLocations().size() &gt;= 1,</span>
				&quot;Path for moving doesn't contains enought steps to move.&quot;);
<span class="nc" id="L331">		display.planScrollingAnimationToPoint(display.getArea().getCenterAreaTo(Point.of(event.getStart())));</span>
<span class="nc" id="L332">		List&lt;Location&gt; path = new ArrayList&lt;&gt;(event.getPath().getLocations());</span>
<span class="nc" id="L333">		path.add(0, event.getStart());</span>
<span class="nc" id="L334">		final WalkAnimator walkAnimator = new WalkAnimator(pathPlanning, path, event.getShip());</span>
<span class="nc" id="L335">		display.setWalkAnimator(walkAnimator);</span>
<span class="nc" id="L336">	}</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>